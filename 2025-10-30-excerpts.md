~~~markdown
## `src/graph/KnowledgeGraphManager.ts`
<KnowledgeGraphManager.ts-L8-L19>
```
  public async loadGraph(): Promise<KnowledgeGraph> {
    return await loadGraphFile();
  }

  private async saveGraph(graph: KnowledgeGraph): Promise<void> {
    await saveGraphFile(graph);
  }

  // Initialize status and priority entities
  async initializeStatusAndPriority(): Promise<void> {
    const graph = await this.loadGraph();
```
</KnowledgeGraphManager.ts-L8-L19>

<KnowledgeGraphManager.ts-L47-L66>
```
  // Helper method to get status of an entity
  async getEntityStatus(entityName: string): Promise<string | null> {
    const graph = await this.loadGraph();

    // Find status relation for this entity
    const statusRelation = graph.relations.find(r =>
      r.from === entityName &&
      r.relationType === 'has_status'
    );

    if (statusRelation) {
      // Extract status value from the status entity name (status:value)
      return statusRelation.to.split(':')[1];
    }

    return null;
  }

  // Helper method to get priority of an entity
  async getEntityPriority(entityName: string): Promise<string | null> {
```
</KnowledgeGraphManager.ts-L47-L66>

## `src/mcp/tools/startsession.ts`
<startsession.ts-L39-L63>
```
          // Get all projects
          const projectsQuery = await kgm.searchNodes("entityType:project");
          const projects = [];

          // Filter for active projects based on has_status relation
          for (const project of projectsQuery.entities) {
            const status = await kgm.getEntityStatus(project.name);
            if (status === "active") {
              projects.push(project);
            }
          }

          // Get tasks
          const taskQuery = await kgm.searchNodes("entityType:task");
          const tasks = [];

          // Filter for high priority and active tasks
          for (const task of taskQuery.entities) {
            const status = await kgm.getEntityStatus(task.name);
            const priority = await kgm.getEntityPriority(task.name);

            if (status === "active" && priority === "high") {
              tasks.push(task);
            }
          }
```
</startsession.ts-L39-L63>

## `src/mcp/tools/loadcontext.ts`
<loadcontext.ts-L60-L85>
```
          if (entityType === "project") {
            // Get project overview
            const projectOverview = await kgm.getProjectOverview(entityName);

            // Get status and priority using relation-based approach
            const status = await kgm.getEntityStatus(entityName) || "Unknown";
            const priority = await kgm.getEntityPriority(entityName);
            const priorityText = priority ? `- **Priority**: ${priority}` : "";

            // Format observations without truncation or pattern matching
            const observationsList = entity.observations.length > 0
              ? entity.observations.map(obs => `- ${obs}`).join("\n")
              : "No observations";

            // Format tasks
            const tasksText = await Promise.all((projectOverview.tasks || []).map(async (task: Entity) => {
              const taskStatus = await kgm.getEntityStatus(task.name) || "Unknown";
              const taskPriority = await kgm.getEntityPriority(task.name) || "Not set";
              // Find the first observation that doesn't look like metadata
              const description = task.observations.find(o =>
                !o.startsWith('Project:') &&
                !o.includes(':')
              ) || "No description";

              return `- **${task.name}** (Status: ${taskStatus}, Priority: ${taskPriority}): ${description}`;
            }));
```
</loadcontext.ts-L60-L85>

## `src/mcp/tools/endsession.ts`
<endsession.ts-L96-L125>
```
            try {
              // Parse arguments
              const summary = args.summary;
              const duration = args.duration;
              const project = args.project;
              const achievements = args.achievements ? JSON.parse(args.achievements) : [];
              const taskUpdates = args.taskUpdates ? JSON.parse(args.taskUpdates) : [];
              const projectStatus = args.projectStatus;
              const projectObservation = args.projectObservation;
              const newTasks = args.newTasks ? JSON.parse(args.newTasks) : [];
              const riskUpdates = args.riskUpdates ? JSON.parse(args.riskUpdates) : [];

              // Create a timestamp to use for entity naming
              const timestamp = new Date().getTime().toString();

              // Create achievement entities and link them to the project
              const achievementEntities = await Promise.all(achievements.map(async (achievement: string, index: number) => {
                const achievementName = `achievement_${timestamp}_${index}`;
                await kgm.createEntities([{
                  name: achievementName,
                  entityType: 'decision',
                  observations: [achievement],
                  embedding: undefined
                }]);

                await kgm.createRelations([{
                  from: achievementName,
                  to: project,
                  relationType: 'part_of',
                  observations: []
```
</endsession.ts-L96-L125>

## `src/storage/sessionStore.ts`
<sessionStore.ts-L4-L26>
```
export async function loadSessionStates(): Promise<Map<string, any[]>> {
  try {
    const fileContent = await fs.readFile(SESSIONS_FILE_PATH, "utf-8");
    const sessions = JSON.parse(fileContent);
    const sessionsMap = new Map<string, any[]>();
    for (const [key, value] of Object.entries(sessions)) {
      sessionsMap.set(key, value as any[]);
    }
    return sessionsMap;
  } catch (error: any) {
    if (error && error.code === "ENOENT") {
      return new Map<string, any[]>();
    }
    throw error;
  }
}

export async function saveSessionStates(sessionsMap: Map<string, any[]>): Promise<void> {
  const sessions: Record<string, any[]> = {};
  for (const [key, value] of sessionsMap.entries()) {
    sessions[key] = value;
  }
  await fs.writeFile(SESSIONS_FILE_PATH, JSON.stringify(sessions, null, 2), "utf-8");
```
</sessionStore.ts-L4-L26>
~~~
